> FLEDGE has been renamed to Protected Audience API. To learn more about the name change, see the [blog post](https://privacysandbox.com/intl/en_us/news/protected-audience-api-our-new-name-for-fledge)

**Author:** <br>
[Priyanka Chatterjee][1], Google Privacy Sandbox

# Bidding and Auction services payload optimization

The [Bidding and Auction (B&A) services][2] outlines a way to allow Protected 
Audience auctions to take place in a [trusted execution environment][3] (TEE) on
a [supported cloud platform][4].

The seller's code in a publisher's web page or Android app sends a unified
contextual and Protected Audience auction HTTPS request (unified request)
to the seller's ad service. The request includes contextual payload and
encrypted [`ProtectedAudienceInput`][5] data.

This document provides guidance for optimization of the Protected Audience data
payload size for DSPs / buyers. This guidance is needed for the following reasons:

* With Bidding and Auction services, sending interest group information to server
  side from the client is expensive, because this impacts overall auction latency
  and increases network cost for sellers and buyers. To mitigate this issue, the
  total size of compressed request payload must be small (less than 50 KB). 
  
* The seller or client may impose a per-buyer payload size limit for
  [`ProtectedAudienceInput`][5]. 
  
Note: The [`ProtectedAudienceInput`][5] request payload is compressed, padded and
then encrypted on the client. The payload is decrypted and decompressed in
Bidding and Auction services.

_Payload optimization is not impacted by K-anonymity integration. The details
about K-anonymity integration with Bidding and Auction services will be published
separately._

## Higher payload driving factors

`ProtectedAudienceInput` payload sizes can be large due to the following reasons:
 * `ads` in [interest groups][6] that includes `renderUrl`(s) and ad `metadata`
 * `adComponents` in interest groups
 * `userBiddingSignals` in interest groups
 * `browserSignals` generated by the browser that are required for [generateBid()][7]
 
## Options for payload optimization

Following are the proposals to optimize compressed ProtectedAudienceInput for DSPs
and buyers. 

![ba-payload-optimization](images/ba-optimized-payload.png)

_The above diagram illustrates the data flow when `adRenderId`s are sent to Bidding
and Auction services using `browserSignals` and `interestGroups` instead of ad objects._

### Optimizing size of ads using ad render ids

Summary: 
DSPs / buyers should generate a short bytestring up to 8 characters long (or 12 characters 
when Base64 encoded) that can serve as an identifier for an ad in an `interestGroup`.
This will be passed to the client (browser / Android) when interestGroups are 
fetched. The client will send `adRenderId`(s) in `interestGroup`(s) (instead of 
ad objects) in [`ProtectedAudienceInput`][5] to Bidding and Auction services.
Bidding and Auction services will pass `adRenderId`(s) in `interestGroup`(s) to 
`generateBid()` that execute in Bidding service. Note that no `ads` object will
be passed in `interestGroup`(s) to `generateBid()`.

#### Step 1
**Buyer generates an identifier for each ad.**

* Generate an `adRenderId`, such as an ID for ad render url. 

* For component ads, similarly generate render identifiers.

* It is recommended that ad render id (or ad component render id) be a string of length
  **8 bytes** or less. If the string is Base64 encoded, it should be **within 12 bytes**.
  
_Note: The ad render id (or ad component render id) size limit is open for feedback from
ad techs._

#### Step 2: 
**Buyer passes `adRenderId` information to the client during interest group fetch.**

Buyer can pass the following information to an [interestGroup][6] when clients
fetch interest groups from buyers' servers.

* An optional `adRenderId` field will be available in the `ads` object in [interest group][6]
  object. 
  * _ Note: The field must be populated by buyers who want to generate bids in 
    TEE based Bidding service. [Turtledove][11] design proposal is updated with
    details about this step._

* An additional field (enum) will be available in interest groups that can help 
  ad techs tell the client how to send the `adRenderId` to the Bidding and Auction
  service. Refer to [step 3][9] for details.
  * _Note: This enum will be supported by browser by September 2023. The 
    [Chrome integration][10] design proposal and [Turtledove][11] design proposal
    will be updated with more details about this step._

#### Step 3:
**Client sends `adRenderId`(s) to the Bidding and Auction service.**

Clients will provide a field (enum) in [interest group][6] to help ad techs provide
their preference between the following two options. **Option 1** is supported
by Chrome and Android. **Option 2** will be supported by September 2023.

##### Option 1: 
**Client sends `adRenderId`(s) (instead of ad objects) in an InterestGroup.**

* The client would send `adRenderId`(s) (and ad component render ids) instead of
  ad objects in an [`interestGroup`][12].
  
* The client sends ad render ids instead of ad objects in `prevWins` of `browserSignals`
  in an [`interestGroup`][12].
  
* The remaining data is passed by the client as described in an [`interestGroup`][12].

Pros: The winning render URL is validated on the client so that they belong to the 
interestGroup that the client has information about. In this case, the winning render
URLs would always pass validation on the client. Ad techs don't need to ensure that
the client is always in sync with their servers or devise a way to generate render
URLs that pass validation on the client deterministically. 

Cons: The payload size will be higher compared to [Option 2][13]. Buyers opting for
Option 1 may be able to send lesser interest groups within the per-buyer payload
size limit as compared to Option 2.

##### Option 2:
**Client (browser, Android) doesn't send ad render ids in interestGroups. 
  Browser sends ad render ids only in `prevWins` of `browserSignals`..**

* The client doesn't send any `adRenderId` in an `interestGroup`. Some ad techs
  can select this option to further optimize their payloads.
  
  * _Note: In this case, the client will also not send any ad information to
    Bidding and Auction services._
    
* The browser sends ad render ids instead of ad objects in `prevWins` of `browserSignals`
  in an `InterestGroup`. Note, this is not relevant to Android since `prevWins`
  are not sent in [AndroidSignals][8].
  
Pros: Smaller `ProtectedAudienceInput` payloads.
 
Cons: The URL of the winning ad candidate sent to the client is validated such 
that they belong to the interest group that the client has information about. With
this option, the URL may fail validation if the device goes out of sync with 
interestGroups in adtech servers.

###### Mitigation
Ad techs must use `adRenderId`(s) in `interestGroup` and information in `trustedBiddingSignals` 
to dynamically generate ad render urls for bids in GenerateBid(). 

One idea that can ensure that the winning ad candidate always passes validation
on the client may be versioning interest group data. The version of the interestGroup
data can be passed to the client when the client fetches interest groups; then
client would pass the version of interest groups for each buyer in [BuyerInput][12]
of [`ProtectedAudienceInput`][5]. Bidding and Auction services can pass the version
when fetching `trustedBiddingSignals` from buyer's Key/Value server.

This mitigation is up for discussion and not supported yet. If an adtech is 
interested in this mitigation, Google Privacy Sandbox (clients, Bidding and
Auction services) can support it. 
  
##### Specification for browser signal

Browser signals are sent to Bidding and Auction services by the browser. This 
information is not relevant for Android app advertising.

Refer below for the spec of browser signal for bidding required for `generateBid()`
for Protected Audience API for web advertising. The only difference here is that
instead of an ad object, an ad render id is passed in `prevWins`. Also refer to 
[BrowserSignals][18] message in B&A API.

```
{ 'topWindowHostname': 'www.example-publisher.com',
  'seller': 'https://www.example-ssp.com',
  'topLevelSeller': 'https://www.another-ssp.com',
  'joinCount': 5,
  'bidCount': 24,
  'recency': 1684134092,
  'prevWins': [[time1, adRenderId1],[time2, adRenderId2],...],
  'wasmHelper': ... /* a WebAssembly.Module object based on interest group's biddingWasmHelperURL */
  'dataVersion': 1, /* Data-Version value from the trusted bidding signals server's response(s) if available */
}
```

_Note: An ad object includes an ad render url and ad metadata. To ensure the 
request payload size is kept small, these are not sent from the client to the 
Bidding and Auction services._

#### Step 4: 
**`generateBid()` can ingest the `adRenderId`(s) in `interestGroup`(s) and `browserSignals`.**

Bidding and Auction services would pass `adRenderId` and ad component render ids 
to [generateBid()][7].

* The Bidding and Auction service passes ad render ids and ad component render ids 
  in `interestGroup` to `generateBid()` if that information is received from the 
  client in [Step 3][9].
  
  * If ad render id (or ad component render ids) information is not available, 
    no ad information is passed to `generateBid()`. This is valid if the buyer
    selects [Option 2][13] in [Step 3][9]. 
    
* `generateBid()` must be updated so that it can ingest ad render ids (or ad 
   component render ids) in the `interestGroup` field.
   
   * Note: This is not required if the buyer selects [Option 2][13] in [Step 3][9]. 

* `generateBid()` needs to be updated so that it can ingest ad render id in 
  `prevWins` in `browserSignals`.
  
  * _This is not relevant for Android app advertising._
  
* The trusted bidding signals fetched from the buyer's Key / Value service must 
  include ad render id and ad metadata information.
  
* `generateBid()` must recreate the ad render urls for final bids.

   * `generateBid()` can maintain a URL template with the base URL. The variable
      part of the URL must be recreated using the information in `interestGroup`
      and `trustedBiddingSignal` arguments. 
      
   * When a buyer selects [Option 2][13] in [Step 3][9], ad render ids are not
     available in the `interestGroup` argument of `generateBid(). In this case,
     the buyer generates the URL dynamically based on the information available
     in `trustedBiddingSignal`. Refer to [mitigation][19] section that proposes
     an idea to ensure URL passes validation on the client deterministically with
     [Option 2][13].
     
### Optimization of user bidding signals

*If a buyer doesn't depend on user bidding signals, they can skip this section.*

Summary: If an ad tech requires user bidding signals, they can use trusted bidding
signal keys to lookup user bidding signals from Key / Value services.

This is optional for [alpha testing][14], but recommended for further optimization.

Pros: Smaller [`ProtectedAudienceInput`][5] payload.

Cons: Ad techs may require additional trusted bidding signal keys so that
user bidding signals can be fetched from buyer's key/value server.

Steps:

* Ad techs can append additional trusted bidding signal keys so that user bidding 
  signals can be made available in `trustedBiddingSignals`. This can help reduce 
  [ProtectedAudienceInput][5] payload further.
  
* During the alpha phase, clients pass the user bidding signals in `InterestGroup` 
  if that information is available / required by a buyer. 
  
### Higher priority interest groups sent from the device

Summary: Prioritize interest groups sent from the device.

Chrome allows buyers to set a priority value (floating point number) per [interest group][6],
however this is optional for buyers today. 

This step is optional for [alpha testing][14].

Pros: Fit higher priority interest groups in the per buyer limit.

Steps:

* Buyer may set priority value per [interest group][7] when interest groups are
  fetched by the client. 

* The client can sort interest groups for buyers based on the priority value, and
  drop lower priority interest groups to meet the per-buyer payload size limit that
  may be set by the seller or the client.
  
## Related material

* [Bidding and Auction services][15]
* [Bidding and Auction services system design explainer][16]
* [Bidding and Auction services multi seller auctions][17]
* [Bidding and Auction services AWS cloud support and deployment guide](https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_aws_guide.md)
* [Bidding and Auction services GCP cloud support and deployment guide](https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_gcp_guide.md)
* [Protected Audience services](https://github.com/privacysandbox/fledge-docs/blob/main/trusted_services_overview.md)
* [Chrome client design for Bidding and Auction services integration](https://github.com/WICG/turtledove/blob/main/FLEDGE_browser_bidding_and_auction_API.md)
* [Android - Bidding and Auction services integration high level document](https://developer.android.com/design-for-safety/privacy-sandbox/protected-audience-bidding-and-auction-services)

[1]: https://github.com/chatterjee-priyanka
[2]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md
[3]: https://github.com/privacysandbox/fledge-docs/blob/main/trusted_services_overview.md#trusted-execution-environment
[4]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#supported-public-cloud-platforms
[5]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#protectedaudienceinput
[6]: https://github.com/WICG/turtledove/blob/main/FLEDGE.md#12-interest-group-attributes
[7]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#generatebid
[8]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#androidsignals
[9]: #step-3
[10]: https://github.com/WICG/turtledove/blob/main/FLEDGE_browser_bidding_and_auction_API.md
[11]: https://github.com/WICG/turtledove/blob/main/FLEDGE.md
[12]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#buyerinput
[13]: #option-2
[14]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#alpha-testing
[15]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md
[16]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_system_design.md
[17]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_multi_seller_auctions.md
[18]: https://github.com/privacysandbox/fledge-docs/blob/main/bidding_auction_services_api.md#browersignals
[19]: #mitigation
